<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Bot Editing - Gestion fichiers</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
    background: url("https://imgur.com/mKW4Iag.jpeg") no-repeat center center fixed;
    background-size: cover;
}

.sidebar {
    width: 220px;
    background: rgba(30, 30, 47, 0.95); 
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 10px;
    gap: 10px;
}

.sidebar img {
    width: 100px;
    margin: 10px auto;
}

.sidebar a {
    color: white;
    text-decoration: none;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    display: block;
}

.sidebar a:hover {
    background: #2a2a40;
}

.quit-btn {
    background: red;
    text-align: center;
    border-radius: 5px;
    padding: 10px;
    cursor: pointer;
    margin-top: auto;
}

.main {
    flex: 1;
    background: rgba(244, 244, 244, 0.9); 
    padding: 20px;
    overflow-y: auto;
    border-radius: 8px;
    margin: 10px;
}

.path {
    margin-bottom: 10px;
    font-weight: bold;
}

.file-list {
    list-style: none;
    padding: 0;
}

.file-item {
    display: flex;
    align-items: center;
    padding: 6px;
    background: white;
    border: 1px solid #ddd;
    margin-bottom: 4px;
    border-radius: 5px;
    cursor: pointer;
    position: relative;
}

.file-item img {
    width: 20px;
    margin-right: 8px;
}

.context-menu {
    position: absolute;
    display: none;
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    z-index: 10;
}

.context-menu div {
    padding: 8px;
    cursor: pointer;
}

.context-menu div:hover {
    background: #eee;
}

#editor {
    height: 80vh;
    width: 100%;
    display: none;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.back-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 10px;
    display: none;
}

.controls {
    margin-bottom: 10px;
}

.controls button {
    margin-right: 5px;
    padding: 5px 10px;
    border-radius: 5px;
    border: none;
    background: #4facfe;
    color: white;
    cursor: pointer;
}

</style>
</head>
<body>
<div class="sidebar">
  <img src="logo.png" alt="Logo">
  <a id="files-tab">üìÇ Fichiers</a>
  <a id="logs-tab">üìù Logs</a>
  <div class="quit-btn" onclick="window.location.href='dashboard.html'">Quitter</div>
</div>

<div class="main">
  <div class="path" id="path">home/container</div>
  
<div class="controls" id="fileControls">
  <button onclick="createFile()">+ Fichier</button>
  <button onclick="createDirectory()">+ Dossier</button>
  <input type="file" id="uploadInput" accept=".py,.txt,text/*" onchange="uploadFile(event)">
  <button onclick="saveFile()">üíæ Enregistrer</button>
</div>

  
  <button class="back-btn" id="backBtn" onclick="goBack()">‚¨Ö Retour</button>
  

  <ul class="file-list" id="fileList"></ul>
  

  <div id="editor"></div>
  

  <div id="contextMenu" class="context-menu">
    <div onclick="renameItem()">Renommer</div>
    <div onclick="deleteItem()">Supprimer</div>
  </div>
  

  <div id="logsContainer" style="display:none;">
    <div id="botStatus" style="margin-bottom:10px;">
      Statut: <span id="statusText">-</span> 
      <span id="statusDot" style="width:10px;height:10px;border-radius:50%;display:inline-block;"></span>
    </div>
    <div id="logsBox" style="background:#000;color:#0f0;padding:10px;height:60vh;overflow-y:auto;font-family:monospace;"></div>
    <div style="margin-top:10px;">
      <button onclick="startBot()">D√©marrer / Red√©marrer</button>
      <button onclick="stopBotUI()">√âteindre</button>
    </div>
  </div>
  <div id="botSizeContainer" style="margin-top:10px;">
    <div style="margin-bottom:5px;">Taille du bot : <span id="sizeText">0</span> / <span id="maxText">0</span> MiB</div>
    <div style="width:100%;background:#ddd;border-radius:5px;height:20px;overflow:hidden;">
        <div id="sizeBar" style="height:100%;width:0%;background:green;"></div>
    </div>
</div>

</div>


<script>
const firebaseConfig = {
  apiKey:"AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain:"kykychat-24c7f.firebaseapp.com",
  databaseURL:"https://kykychat-24c7f-default-rtdb.firebaseio.com",
  projectId:"kykychat-24c7f",
  storageBucket:"kykychat-24c7f.firebasestorage.app",
  messagingSenderId:"342562811927",
  appId:"1:342562811927:web:0fed1e1f511c4fddcfec52"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser, currentBot, currentPath="home/container", currentFile=null, currentItem=null;


let editor = ace.edit("editor");
editor.setTheme("ace/theme/monokai");
editor.session.setMode("ace/mode/text");


const filesTab = document.getElementById("files-tab");
const logsTab = document.getElementById("logs-tab");
const fileListEl = document.getElementById("fileList");
const editorEl = document.getElementById("editor");
const fileControls = document.getElementById("fileControls");
const logsContainer = document.getElementById("logsContainer");
const statusText = document.getElementById("statusText");
const statusDot = document.getElementById("statusDot");
const logsBox = document.getElementById("logsBox");


firebase.auth().onAuthStateChanged(user=>{
  if(!user) return window.location="index.html";
  currentUser = user.uid;
  db.ref(`users/${currentUser}/noweditingBot`).once("value").then(snap=>{
    currentBot = snap.val();
    if(!currentBot) return alert("Aucun bot en cours d'√©dition !");
    loadFiles();
    updateStatus();
  });
});


function formatFilename(name,toDisplay=true){
  if(toDisplay) return name.replace(/_/g,".");
  else return name.replace(/\./g,"_");
}


function getRef(path=currentPath){
  const relPath = path.replace("home/container","");
  return db.ref(`users/${currentUser}/bots/${currentBot}/files${relPath}`);
}


function copyNode(sourceRef, targetRef){
  sourceRef.once("value").then(snap=>{
    targetRef.set(snap.val(), err=>{
      if(err) console.error("Erreur copy:", err);
      else sourceRef.remove();
    });
  });
}


function saveFile(){
  if(!currentFile) return alert("Aucun fichier ouvert");
  let content = editor.getValue().replace(/\n/g,"{%hostjump%}");
  getRef().child(currentFile).set(content, err=>{
    if(err) alert("Erreur lors de la sauvegarde : "+err);
    else alert("Fichier sauvegard√© ‚úÖ");
  });
}


function createFile(){
  let name = prompt("Nom du fichier (ex: test.py)");
  if(!name) return;
  let dbName = formatFilename(name,false);
  getRef().child(dbName).set(" ", err=>{
    if(err) alert("Erreur cr√©ation fichier : "+err);
    loadFiles();
  });
}


function createDirectory(){
  let name = prompt("Nom du dossier");
  if(!name) return;
  getRef().child(name).set({}, err=>{
    if(err) alert("Erreur cr√©ation dossier : "+err);
    loadFiles();
  });
}


function uploadFile(e){
  const file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(ev){
    let content = ev.target.result.replace(/\n/g,"{%hostjump%}");
    let dbName = formatFilename(file.name,false);
    getRef().child(dbName).set(content, err=>{
      if(err) alert("Erreur upload : "+err);
      loadFiles();
    });
  };
  reader.readAsText(file);
}


function openFile(name, content){
  currentFile = name;
  fileListEl.style.display = "none";
  editorEl.style.display = "block";
  document.getElementById("backBtn").style.display = "inline-block";
  fileControls.style.display = "block"; // garder le bouton Enregistrer visible

  let lang = "text";
  if(name.endsWith("_py")) lang = "python";
  if(name.endsWith("_txt")) lang = "text";
  editor.session.setMode("ace/mode/" + lang);
  editor.setValue(content.replace(/{%hostjump%}/g,"\n"), -1);
}



function goBack(){
  if(currentFile){currentFile=null;loadFiles();}
  else{
    let parts = currentPath.split("/");
    if(parts.length>2){
      parts.pop();
      currentPath = parts.join("/");
      loadFiles();
    }
  }
}


function saveFile(){
  if(!currentFile) return alert("Aucun fichier ouvert");
  let content = editor.getValue().replace(/\n/g,"{%hostjump%}");
  getRef().child(currentFile).set(content);
  alert("Fichier sauvegard√© !");
}


let contextMenu = document.getElementById("contextMenu");
function showContextMenu(x,y,f){
  contextMenu.style.display="block";
  contextMenu.style.left = x+"px";
  contextMenu.style.top = y+"px";
}
document.addEventListener("click",()=>{contextMenu.style.display="none";});


function deleteItem(){
  if(!confirm("Supprimer cet √©l√©ment ?")) return;
  getRef().child(currentFile).remove();
  loadFiles();
}
function renameItem(){
  let newName = prompt("Nouveau nom :",currentFile);
  if(!newName) return;
  let dbNew = formatFilename(newName,false);
  let sourceRef = getRef().child(currentFile);
  let targetRef = getRef().child(dbNew);
  copyNode(sourceRef,targetRef);
  currentFile = null;
  loadFiles();
}


function updateBreadcrumb(){
  const pathDiv = document.getElementById("path");
  pathDiv.innerHTML = "";
  let parts = currentPath.split("/");
  let accumulated = [];
  parts.forEach((p,i)=>{
    accumulated.push(p);
    let span = document.createElement("span");
    span.innerText = p;
    span.style.cursor = "pointer";
    span.style.textDecoration = "underline";
    span.style.marginRight = "5px";
    span.onclick = ()=>{currentPath = accumulated.join("/"); loadFiles();};
    pathDiv.appendChild(span);
    if(i<parts.length-1){
      let sep = document.createElement("span");
      sep.innerText = "/";
      sep.style.marginRight="5px";
      pathDiv.appendChild(sep);
    }
  });
}


function loadFiles(){
  fileListEl.innerHTML="";
  editorEl.style.display="none";
  fileControls.style.display="block";
  document.getElementById("backBtn").style.display=(currentPath==="home/container")?"none":"inline-block";
  updateBreadcrumb();

  getRef().once("value").then(snap=>{
    const files = snap.val() || {};
    for(let f in files){
      let li = document.createElement("li");
      li.className = "file-item";
      currentItem = li;
      let displayName = formatFilename(f,true);
      let imgSrc = "unknown.png";
      if(typeof files[f] === "object") imgSrc = "directory.png";
      else if(f.endsWith("_py")) imgSrc = "py.png";
      else if(f.endsWith("_txt")) imgSrc = "txt.png";

      li.innerHTML = `<img src="${imgSrc}">${displayName}`;
      li.onclick = ()=>{
        if(typeof files[f]==="object"){currentPath+="/"+f;loadFiles();}
        else{openFile(f,files[f]);}
      };
      li.oncontextmenu = (e)=>{
        e.preventDefault();
        currentItem=li;
        currentFile=f;
        showContextMenu(e.clientX,e.clientY,f);
      };
      fileListEl.appendChild(li);
    }
  });
}


filesTab.onclick = ()=>{
  fileListEl.style.display="block";
  editorEl.style.display=(currentFile)?"block":"none";
  logsContainer.style.display="none";
  fileControls.style.display="block";
};

logsTab.onclick = ()=> {
    fileListEl.style.display="none";
    editorEl.style.display="none";
    fileControls.style.display="none";
    logsContainer.style.display="block";
    loadLogs();
    updateBotSize(); 
};



function addLog(msg, color="#0f0"){
  const line = document.createElement("div");
  line.innerText = msg;
  line.style.color = color;
  logsBox.appendChild(line);
  logsBox.scrollTop = logsBox.scrollHeight;
}

function updateStatus(){
    const statusRef = db.ref(`users/${currentUser}/bots/${currentBot}/status`);
    const logsRef = db.ref(`users/${currentUser}/bots/${currentBot}/logs`);
    
    statusRef.on("value", snap => {
        const status = snap.val();
        if(status === "true"){
            statusText.innerText = "D√©marrage...";
            statusDot.style.background = "orange";
        } else if(status === "online"){
            statusText.innerText = "En ligne";
            statusDot.style.background = "green";
        } else if(status === "false"){
            statusText.innerText = "Arr√™t...";
            statusDot.style.background = "orange";
        } else if(status === "offline"){
            statusText.innerText = "Arr√™t√©";
            statusDot.style.background = "red";
            // Effacer logs c√¥t√© UI
            logsBox.innerHTML = "";
            // Supprimer logs dans Firebase
            logsRef.remove().then(()=> {
                console.log("Logs supprim√©s car bot offline");
            });
        }
    });
}


let logsInterval;

function loadLogs(){
    logsBox.innerHTML = "";
    addLog("Chargement des logs...");

    const logsRef = db.ref(`users/${currentUser}/bots/${currentBot}/logs`);


    if (logsInterval) clearInterval(logsInterval);


    logsInterval = setInterval(() => {
        logsRef.once("value").then(snap => {
            const logs = snap.val() || {};
            logsBox.innerHTML = ""; 
            const sortedKeys = Object.keys(logs).sort((a, b) => parseInt(a) - parseInt(b));
            sortedKeys.forEach(key => {
                addLog(logs[key]);
            });
        });
    }, 1000);
}



function startBot(){
  db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"true"}).then(()=>{
    addLog("D√©marrage du bot...");
    setTimeout(()=>{
      db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"online"});
      addLog("Bot en ligne ‚úÖ");
      updateStatus();
    },2000);
    updateStatus();
  });
}

function stopBotUI(){
  db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"false"}).then(()=>{
    addLog("Arr√™t du bot...");
    setTimeout(()=>{
      db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"offline"});
      addLog("Bot arr√™t√© ‚ùå");
      updateStatus();
    },2000);
    updateStatus();
  });
}

function loadLogs(){
  logsBox.innerHTML="";
  updateStatus();
  addLog("Chargement des logs...");
  db.ref(`users/${currentUser}/bots/${currentBot}/logs`).once("value").then(snap=>{
    const logs = snap.val()||{};
    for(let key in logs){
      addLog(logs[key]);
    }
  });
}

function updateBotSize() {
    const sizeRef = db.ref(`users/${currentUser}/bots/${currentBot}`);
    sizeRef.on("value", snap => {
        const data = snap.val();
        if (!data) return;

        const size = data.size || 0;       
        const max = data.maxLimit || 1;    
        const sizeMiB = (size / (1024*1024)).toFixed(2);
        const maxMiB = (max / (1024*1024)).toFixed(2);

        document.getElementById("sizeText").innerText = sizeMiB;
        document.getElementById("maxText").innerText = maxMiB;

        let percent = Math.min(100, (size / max) * 100);
        const bar = document.getElementById("sizeBar");
        bar.style.width = percent + "%";


        if (percent >= 100) bar.style.background = "red";
        else if (max - size <= 10 * 1024 * 1024) bar.style.background = "orange"; 
        else bar.style.background = "green";
    });
}



loadFiles();
</script>


</body>
</html>
