<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Bot Editing - Gestion fichiers</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;display:flex;height:100vh}
.sidebar{width:220px;background:#1e1e2f;color:white;display:flex;flex-direction:column;justify-content:flex-start;padding:10px;gap:10px}
.sidebar img{width:100px;margin:10px auto}
.sidebar a{color:white;text-decoration:none;padding:10px;border-radius:5px;cursor:pointer;display:block}
.sidebar a:hover{background:#2a2a40}
.quit-btn{background:red;text-align:center;border-radius:5px;padding:10px;cursor:pointer;margin-top:auto}
.main{flex:1;background:#f4f4f4;padding:20px;overflow-y:auto}
.path{margin-bottom:10px;font-weight:bold}
.file-list{list-style:none;padding:0}
.file-item{display:flex;align-items:center;padding:6px;background:white;border:1px solid #ddd;margin-bottom:4px;border-radius:5px;cursor:pointer;position:relative}
.file-item img{width:20px;margin-right:8px}
.context-menu{position:absolute;display:none;background:white;border:1px solid #ccc;border-radius:5px;z-index:10}
.context-menu div{padding:8px;cursor:pointer}
.context-menu div:hover{background:#eee}
#editor{height:80vh;width:100%;display:none;border:1px solid #ccc;border-radius:5px}
.back-btn{background:#007bff;color:white;border:none;padding:8px 12px;border-radius:5px;cursor:pointer;margin-bottom:10px;display:none}
.controls{margin-bottom:10px}
.controls button{margin-right:5px;padding:5px 10px;border-radius:5px;border:none;background:#4facfe;color:white;cursor:pointer}
</style>
</head>
<body>
<div class="sidebar">
  <img src="logo.png" alt="Logo">
  <a id="files-tab">üìÇ Fichiers</a>
  <a id="logs-tab">üìù Logs</a>
  <div class="quit-btn" onclick="window.location.href='dashboard.html'">Quitter</div>
</div>
<div class="main">
  <div class="path" id="path">home/container</div>
  <div class="controls">
    <button onclick="createFile()">+ Fichier</button>
    <button onclick="createDirectory()">+ Dossier</button>
    <input type="file" id="uploadInput" accept=".py,.txt,text/*" onchange="uploadFile(event)">
    <button onclick="saveFile()">üíæ Enregistrer</button>
  </div>
  <button class="back-btn" id="backBtn" onclick="goBack()">‚¨Ö Retour</button>
  <ul class="file-list" id="fileList"></ul>
  <div id="editor"></div>
  <div id="contextMenu" class="context-menu">
    <div onclick="renameItem()">Renommer</div>
    <div onclick="deleteItem()">Supprimer</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain:"kykychat-24c7f.firebaseapp.com",
  databaseURL:"https://kykychat-24c7f-default-rtdb.firebaseio.com",
  projectId:"kykychat-24c7f",
  storageBucket:"kykychat-24c7f.firebasestorage.app",
  messagingSenderId:"342562811927",
  appId:"1:342562811927:web:0fed1e1f511c4fddcfec52"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser, currentBot, currentPath="home/container", currentFile=null, currentItem=null;
let editor = ace.edit("editor");
editor.setTheme("ace/theme/monokai");
editor.session.setMode("ace/mode/text");

firebase.auth().onAuthStateChanged(user=>{
  if(!user) return window.location="index.html";
  currentUser = user.uid;
  db.ref(`users/${currentUser}/noweditingBot`).once("value").then(snap=>{
    currentBot = snap.val();
    if(!currentBot) return alert("Aucun bot en cours d'√©dition !");
    loadFiles();
  });
});

function formatFilename(name,toDisplay=true){
  if(toDisplay) return name.replace(/_/g,".");
  else return name.replace(/\./g,"_");
}

function getRef(path=currentPath){
  const relPath = path.replace("home/container","");
  return db.ref(`users/${currentUser}/bots/${currentBot}/files${relPath}`);
}

// Copier un noeud Firebase pour renommer
function copyNode(sourceRef, targetRef){
  sourceRef.once("value").then(snap=>{
    targetRef.set(snap.val(), err=>{
      if(err) console.error("Erreur copy:", err);
      else sourceRef.remove();
    });
  });
}

// Cr√©er fichier
function createFile(){
  let name = prompt("Nom du fichier (ex: test.py)");
  if(!name) return;
  let dbName = formatFilename(name,false);
  getRef().child(dbName).set(" ");
  loadFiles();
}

// Cr√©er dossier
function createDirectory(){
  let name = prompt("Nom du dossier");
  if(!name) return;
  getRef().child(name).set({});
  loadFiles();
}

// Upload fichier texte
function uploadFile(e){
  const file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(ev){
    let content = ev.target.result.replace(/\n/g,"{%hostjump%}");
    let dbName = formatFilename(file.name,false);
    getRef().child(dbName).set(content);
    loadFiles();
  };
  reader.readAsText(file);
}

// Ouvrir fichier
function openFile(name,content){
  currentFile = name;
  document.getElementById("fileList").innerHTML="";
  document.getElementById("editor").style.display="block";
  document.getElementById("backBtn").style.display="inline-block";

  let lang = "text";
  if(name.endsWith("_py")) lang="python";
  if(name.endsWith("_txt")) lang="text";
  editor.session.setMode("ace/mode/"+lang);
  editor.setValue(content.replace(/{%hostjump%}/g,"\n"),-1);
}

// Retour arri√®re
function goBack(){
  if(currentFile){currentFile=null;loadFiles();}
  else{
    let parts = currentPath.split("/");
    if(parts.length>2){
      parts.pop();
      currentPath = parts.join("/");
      loadFiles();
    }
  }
}

// Sauvegarder fichier
function saveFile(){
  if(!currentFile) return alert("Aucun fichier ouvert");
  let content = editor.getValue().replace(/\n/g,"{%hostjump%}");
  getRef().child(currentFile).set(content);
  alert("Fichier sauvegard√© !");
}

// Menu contextuel
let contextMenu = document.getElementById("contextMenu");
function showContextMenu(x,y,f){
  contextMenu.style.display="block";
  contextMenu.style.left = x+"px";
  contextMenu.style.top = y+"px";
}
document.addEventListener("click",()=>{contextMenu.style.display="none";});

// Supprimer
function deleteItem(){
  if(!confirm("Supprimer cet √©l√©ment ?")) return;
  getRef().child(currentFile).remove();
  loadFiles();
}

// Renommer
function renameItem(){
  let newName = prompt("Nouveau nom :",currentFile);
  if(!newName) return;
  let dbNew = formatFilename(newName,false);
  let sourceRef = getRef().child(currentFile);
  let targetRef = getRef().child(dbNew);
  copyNode(sourceRef,targetRef);
  currentFile = null;
  loadFiles();
}

// Breadcrumb clickable
function updateBreadcrumb(){
  const pathDiv = document.getElementById("path");
  pathDiv.innerHTML = "";
  let parts = currentPath.split("/");
  let accumulated = [];
  parts.forEach((p,i)=>{
    accumulated.push(p);
    let span = document.createElement("span");
    span.innerText = p;
    span.style.cursor = "pointer";
    span.style.textDecoration = "underline";
    span.style.marginRight = "5px";
    span.onclick = ()=>{
      currentPath = accumulated.join("/");
      loadFiles();
    };
    pathDiv.appendChild(span);
    if(i<parts.length-1){
      let sep = document.createElement("span");
      sep.innerText = "/";
      sep.style.marginRight="5px";
      pathDiv.appendChild(sep);
    }
  });
}

// Charger fichiers et dossiers
function loadFiles(){
  document.getElementById("fileList").innerHTML="";
  document.getElementById("editor").style.display="none";
  document.getElementById("backBtn").style.display=(currentPath==="home/container")?"none":"inline-block";
  updateBreadcrumb();

  getRef().once("value").then(snap=>{
    const files = snap.val() || {};
    for(let f in files){
      let li = document.createElement("li");
      li.className = "file-item";
      currentItem = li;
      let displayName = formatFilename(f,true);
      let imgSrc = "unknown.png";
      if(typeof files[f] === "object") imgSrc = "directory.png";
      else if(f.endsWith("_py")) imgSrc = "py.png";
      else if(f.endsWith("_txt")) imgSrc = "txt.png";

      li.innerHTML = `<img src="${imgSrc}">${displayName}`;
      li.onclick = ()=>{
        if(typeof files[f]==="object"){currentPath+="/"+f;loadFiles();}
        else{openFile(f,files[f]);}
      };
      li.oncontextmenu = (e)=>{
        e.preventDefault();
        currentItem=li;
        currentFile=f;
        showContextMenu(e.clientX,e.clientY,f);
      };
      document.getElementById("fileList").appendChild(li);
    }
  });
}

// Initial load
loadFiles();
</script>

</body>
</html>
