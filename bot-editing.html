<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Bot Editing - Gestion fichiers</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
<style>
body {
    margin: 0;
    font-family: 'Montserrat', Arial, sans-serif;
    display: flex;
    height: 100vh;
    background: url("https://imgur.com/mKW4Iag.jpeg") no-repeat center center fixed;
    background-size: cover;
    color: #222;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.sidebar {
    width: 70px; /* compacte */
    background: linear-gradient(to bottom, #243B55, #141E30); /* d√©grad√© bleu */
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px 0;
    gap: 20px;
    border-radius: 0 20px 20px 0;
    box-shadow: 4px 0 15px rgba(0,0,0,0.3);
    backdrop-filter: blur(6px);
}

.sidebar img {
    width: 40px;
    margin: 10px 0 30px 0;
    filter: drop-shadow(0 0 6px #4facfe);
}

.sidebar a {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.25s ease;
    font-size: 1.5em; /* si ic√¥nes emoji */
}

.sidebar a:hover {
    background: rgba(255,255,255,0.15);
    transform: scale(1.1);
}

/* bouton quitter en bas */
.quit-btn {
    margin-top: auto;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg,#ff5858,#f09819);
    border-radius: 12px;
    font-size: 1.3em;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: transform 0.25s;
}
.quit-btn:hover {
    transform: scale(1.15);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.main {
    flex: 1;
    background: rgba(255,255,255,0.75);
    padding: 35px 30px;
    margin: 20px;
    border-radius: 30px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    backdrop-filter: blur(10px);
    overflow-y: auto;
}

/* Breadcrumb */
.path {
    margin-bottom: 22px;
    font-weight: 700;
    font-size: 1.2em;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.path span {
    background: rgba(255,255,255,0.85);
    padding: 6px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}
.path span:hover {
    background: #4facfe;
    color: #fff;
}

/* File list */
.file-list {
    list-style: none;
    padding: 0;
    margin-top: 15px;
}
.file-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255,255,255,0.9);
    border: 1px solid #e5e5e5;
    margin-bottom: 10px;
    border-radius: 12px;
    font-size: 1.05em;
    font-weight: 500;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.25s ease;
    cursor: pointer;
}
.file-item:hover {
    background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
    color: #111;
    transform: scale(1.02);
}
.file-item img {
    width: 26px;
    margin-right: 12px;
}

/* Context menu */
.context-menu {
    position: absolute;
    display: none;
    background: white;
    border: 1px solid #ccc;
    border-radius: 12px;
    z-index: 20;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    overflow: hidden;
}
.context-menu div {
    padding: 12px 18px;
    cursor: pointer;
    transition: background 0.2s;
}
.context-menu div:hover {
    background: #4facfe;
    color: #fff;
}

/* Ace editor */
#editor {
    height: 70vh;
    width: 100%;
    display: none;
    border: 1px solid #ccc;
    border-radius: 16px;
    margin-top: 20px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.12);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Boutons harmonis√©s avec la sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
button,
.back-btn,
.controls button {
    border: none;
    padding: 10px 18px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    background: linear-gradient(to right, #243B55, #141E30); /* m√™me palette que sidebar */
    color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: all 0.3s ease;
    font-size: 0.95em;
}
button:hover,
.back-btn:hover,
.controls button:hover {
    background: linear-gradient(to right, #3a557a, #1c2b45);
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 16px rgba(79,172,254,0.4);
}

.controls {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
}
.controls input[type="file"] {
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(to right, #243B55, #141E30);
    color: #fff;
    font-size: 0.9em;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    transition: all 0.3s ease;
}
.controls input[type="file"]:hover {
    background: linear-gradient(to right, #3a557a, #1c2b45);
    transform: scale(1.03);
    box-shadow: 0 5px 14px rgba(79,172,254,0.35);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Logs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#logsContainer {
    margin-top: 20px;
    border-radius: 20px;
    background: rgba(15,15,15,0.9);
    padding: 20px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.15);
}
#botStatus {
    font-size: 1.2em;
    font-weight: bold;
    color: #fff;
}
#statusDot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: inline-block;
    margin-left: 10px;
    box-shadow: 0 0 10px #4facfe;
}
#logsBox {
    background: #111;
    color: #0f0;
    padding: 16px;
    height: 50vh;
    overflow-y: auto;
    font-family: 'Fira Mono', monospace;
    border-radius: 12px;
    margin-top: 12px;
    font-size: 0.95em;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Bot size ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#botSizeContainer {
    margin-top: 20px;
    background: rgba(255,255,255,0.85);
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}
#sizeBar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg,#4caf50,#8bc34a);
    border-radius: 8px;
    transition: width 0.4s, background 0.3s;
}


</style>
</head>
<body>
<div class="sidebar">
  <img src="logo.png" alt="Logo">
  <a id="files-tab">üìÇ</a>
  <a id="logs-tab">üìù</a>
  <div class="quit-btn" onclick="window.location.href='dashboard.html'">X</div>
</div>

<div class="main">
  <div class="path" id="path">home/container</div>
  
<div class="controls" id="fileControls">
  <button onclick="createFile()">+ Fichier</button>
  <button onclick="createDirectory()">+ Dossier</button>
  <input type="file" id="uploadInput" accept=".py,.txt,text/*" onchange="uploadFile(event)">
  <button onclick="saveFile()">üíæ Enregistrer</button>
</div>

  
  <button class="back-btn" id="backBtn" onclick="goBack()">‚¨Ö Retour</button>
  

  <ul class="file-list" id="fileList"></ul>
  

  <div id="editor"></div>
  

  <div id="contextMenu" class="context-menu">
    <div onclick="renameItem()">Renommer</div>
    <div onclick="deleteItem()">Supprimer</div>
  </div>
  

  <div id="logsContainer" style="display:none;">
    <div id="botStatus" style="margin-bottom:10px;">
      Statut: <span id="statusText">-</span> 
      <span id="statusDot" style="width:10px;height:10px;border-radius:50%;display:inline-block;"></span>
    </div>
    <div id="logsBox" style="background:#000;color:#0f0;padding:10px;height:60vh;overflow-y:auto;font-family:monospace;"></div>
    <div style="margin-top:10px;">
      <button onclick="startBot()">D√©marrer</button>
      <button onclick="stopBotUI()">√âteindre</button>
    </div>
  </div>
  <div id="botSizeContainer" style="margin-top:10px;">
    <div style="margin-bottom:5px;">Taille du bot : <span id="sizeText">0</span> / <span id="maxText">0</span> MiB</div>
    <div style="width:100%;background:#ddd;border-radius:5px;height:20px;overflow:hidden;">
        <div id="sizeBar" style="height:100%;width:0%;background:green;"></div>
    </div>
</div>

</div>


<script>
const firebaseConfig = {
  apiKey:"AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain:"kykychat-24c7f.firebaseapp.com",
  databaseURL:"https://kykychat-24c7f-default-rtdb.firebaseio.com",
  projectId:"kykychat-24c7f",
  storageBucket:"kykychat-24c7f.firebasestorage.app",
  messagingSenderId:"342562811927",
  appId:"1:342562811927:web:0fed1e1f511c4fddcfec52"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser, currentBot, currentPath="home/container", currentFile=null, currentItem=null;


let editor = ace.edit("editor");
editor.setTheme("ace/theme/monokai");
editor.session.setMode("ace/mode/text");


const filesTab = document.getElementById("files-tab");
const logsTab = document.getElementById("logs-tab");
const fileListEl = document.getElementById("fileList");
const editorEl = document.getElementById("editor");
const fileControls = document.getElementById("fileControls");
const logsContainer = document.getElementById("logsContainer");
const statusText = document.getElementById("statusText");
const statusDot = document.getElementById("statusDot");
const logsBox = document.getElementById("logsBox");


firebase.auth().onAuthStateChanged(user=>{
  if(!user) return window.location="index.html";
  currentUser = user.uid;
  db.ref(`users/${currentUser}/noweditingBot`).once("value").then(snap=>{
    currentBot = snap.val();
    if(!currentBot) return alert("Aucun bot en cours d'√©dition !");
    loadFiles();
    attachStatusListener();   // <-- statut en temps r√©el
    attachLogsListener();     // <-- logs en temps r√©el
    updateBotSize();
  });
});


function formatFilename(name,toDisplay=true){
  if(toDisplay) return name.replace(/_/g,".");
  else return name.replace(/\./g,"_");
}


function getRef(path=currentPath){
  const relPath = path.replace("home/container","");
  return db.ref(`users/${currentUser}/bots/${currentBot}/files${relPath}`);
}


function copyNode(sourceRef, targetRef){
  sourceRef.once("value").then(snap=>{
    targetRef.set(snap.val(), err=>{
      if(err) console.error("Erreur copy:", err);
      else sourceRef.remove();
    });
  });
}


function saveFile(){
  if(!currentFile) return alert("Aucun fichier ouvert");
  let content = editor.getValue().replace(/\n/g,"{%hostjump%}");
  getRef().child(currentFile).set(content, err=>{
    if(err) alert("Erreur lors de la sauvegarde : "+err);
    else alert("Fichier sauvegard√© ‚úÖ");
  });
}


function createFile(){
  let name = prompt("Nom du fichier (ex: test.py)");
  if(!name) return;
  let dbName = formatFilename(name,false);
  // V√©rifie si le fichier existe d√©j√†
  getRef().child(dbName).once("value").then(snap=>{
    if(snap.exists()) {
      alert("Ce fichier existe d√©j√† !");
      return;
    }
    getRef().child(dbName).set(" ", err=>{
      if(err) alert("Erreur cr√©ation fichier : "+err);
      else {
        loadFiles();
        updateBotSize(); // Met √† jour la taille apr√®s cr√©ation
      }
    });
  });
}


function createDirectory(){
  let name = prompt("Nom du dossier");
  if(!name) return;
  getRef().child(name).set({}, err=>{
    if(err) alert("Erreur cr√©ation dossier : "+err);
    loadFiles();
  });
}


function uploadFile(e){
  const file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(ev){
    let content = ev.target.result.replace(/\n/g,"{%hostjump%}");
    let dbName = formatFilename(file.name,false);
    getRef().child(dbName).set(content, err=>{
      if(err) alert("Erreur upload : "+err);
      else {
        loadFiles();
        updateBotSize(); // Met √† jour la taille apr√®s upload
      }
    });
  };
  reader.readAsText(file);
}


function openFile(name, content){
  currentFile = name;
  fileListEl.style.display = "none";
  editorEl.style.display = "block";
  document.getElementById("backBtn").style.display = "inline-block";
  fileControls.style.display = "block"; // garder le bouton Enregistrer visible

  let lang = "text";
  if(name.endsWith("_py")) lang = "python";
  if(name.endsWith("_txt")) lang = "text";
  editor.session.setMode("ace/mode/" + lang);
  editor.setValue(content.replace(/{%hostjump%}/g,"\n"), -1);
}



function goBack(){
  if(currentFile){currentFile=null;loadFiles();}
  else{
    let parts = currentPath.split("/");
    if(parts.length>2){
      parts.pop();
      currentPath = parts.join("/");
      loadFiles();
    }
  }
}


function saveFile(){
  if(!currentFile) return alert("Aucun fichier ouvert");
  let content = editor.getValue().replace(/\n/g,"{%hostjump%}");
  getRef().child(currentFile).set(content);
  alert("Fichier sauvegard√© !");
}


let contextMenu = document.getElementById("contextMenu");
function showContextMenu(x,y,f){
  contextMenu.style.display="block";
  contextMenu.style.left = x+"px";
  contextMenu.style.top = y+"px";
}
document.addEventListener("click",()=>{contextMenu.style.display="none";});


function deleteItem(){
  if(!confirm("Supprimer cet √©l√©ment ?")) return;
  getRef().child(currentFile).remove().then(()=>{
    loadFiles();
    updateBotSize(); // Met √† jour la taille apr√®s suppression
  });
}
function renameItem(){
  let newName = prompt("Nouveau nom :",currentFile);
  if(!newName) return;
  let dbNew = formatFilename(newName,false);
  let sourceRef = getRef().child(currentFile);
  let targetRef = getRef().child(dbNew);
  copyNode(sourceRef,targetRef);
  currentFile = null;
  setTimeout(()=>{
    loadFiles();
    updateBotSize(); // Met √† jour la taille apr√®s renommage
  }, 500);
}


function updateBreadcrumb(){
  const pathDiv = document.getElementById("path");
  pathDiv.innerHTML = "";
  let parts = currentPath.split("/");
  let accumulated = [];
  parts.forEach((p,i)=>{
    accumulated.push(p);
    let span = document.createElement("span");
    span.innerText = p;
    span.style.cursor = "pointer";
    span.style.textDecoration = "underline";
    span.style.marginRight = "5px";
    span.onclick = ()=>{currentPath = accumulated.join("/"); loadFiles();};
    pathDiv.appendChild(span);
    if(i<parts.length-1){
      let sep = document.createElement("span");
      sep.innerText = "/";
      sep.style.marginRight="5px";
      pathDiv.appendChild(sep);
    }
  });
}


function loadFiles(){
  fileListEl.innerHTML="";
  editorEl.style.display="none";
  fileControls.style.display="block";
  document.getElementById("backBtn").style.display=(currentPath==="home/container")?"none":"inline-block";
  updateBreadcrumb();

  getRef().once("value").then(snap=>{
    const files = snap.val() || {};
    for(let f in files){
      let li = document.createElement("li");
      li.className = "file-item";
      currentItem = li;
      let displayName = formatFilename(f,true);
      let imgSrc = "unknown.png";
      if(typeof files[f] === "object") imgSrc = "directory.png";
      else if(f.endsWith("_py")) imgSrc = "py.png";
      else if(f.endsWith("_txt")) imgSrc = "txt.png";

      li.innerHTML = `<img src="${imgSrc}">${displayName}`;
      li.onclick = ()=>{
        if(typeof files[f]==="object"){currentPath+="/"+f;loadFiles();}
        else{openFile(f,files[f]);}
      };
      li.oncontextmenu = (e)=>{
        e.preventDefault();
        currentItem=li;
        currentFile=f;
        showContextMenu(e.clientX,e.clientY,f);
      };
      fileListEl.appendChild(li);
    }
    updateBotSize(); // Met √† jour la taille √† chaque affichage
  });
}


filesTab.onclick = ()=>{
  fileListEl.style.display="block";
  editorEl.style.display=(currentFile)?"block":"none";
  logsContainer.style.display="none";
  fileControls.style.display="block";
};

logsTab.onclick = ()=> {
    fileListEl.style.display="none";
    editorEl.style.display="none";
    fileControls.style.display="none";
    logsContainer.style.display="block";
    loadLogs();
    updateBotSize(); 
};



function addLog(msg, color="#0f0"){
  const line = document.createElement("div");
  line.innerText = msg;
  line.style.color = color;
  logsBox.appendChild(line);
  logsBox.scrollTop = logsBox.scrollHeight;
}

function attachStatusListener(){
    const statusRef = db.ref(`users/${currentUser}/bots/${currentBot}/status`);
    statusRef.on("value", snap => {
        const status = snap.val();
        if(status === "true"){
            statusText.innerText = "D√©marrage...";
            statusDot.style.background = "orange";
        } else if(status === "online"){
            statusText.innerText = "En ligne";
            statusDot.style.background = "green";
        } else if(status === "false"){
            statusText.innerText = "Arr√™t...";
            statusDot.style.background = "orange";
        } else if(status === "offline"){
            statusText.innerText = "Arr√™t√©";
            statusDot.style.background = "red";
            logsBox.innerHTML = "";
        }
    });
}


let logsInterval;

function loadLogs(){
    logsBox.innerHTML = "";
    addLog("Chargement des logs...");

    const logsRef = db.ref(`users/${currentUser}/bots/${currentBot}/logs`);

    // √âcoute en temps r√©el
    logsRef.on("value", snap => {
        const logs = snap.val() || {};
        logsBox.innerHTML = ""; // vide avant d'afficher
        const sortedKeys = Object.keys(logs).sort((a,b) => parseInt(a)-parseInt(b));
        sortedKeys.forEach(key => {
            addLog(logs[key]);
        });
    });
}




function startBot(){
  db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"true"}).then(()=>{
    addLog("D√©marrage du bot...");
    setTimeout(()=>{
      db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"online"});
      addLog("Bot en ligne ‚úÖ");
      updateStatus();
    },2000);
    updateStatus();
  });
}

function stopBotUI(){
  db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"false"}).then(()=>{
    addLog("Arr√™t du bot...");
    setTimeout(()=>{
      db.ref(`users/${currentUser}/bots/${currentBot}`).update({status:"offline"});
      addLog("Bot arr√™t√© ‚ùå");
      updateStatus();
    },2000);
    updateStatus();
  });
}

function attachLogsListener(){
    const logsRef = db.ref(`users/${currentUser}/bots/${currentBot}/logs`);
    logsRef.on("value", snap => {
        const logs = snap.val() || {};
        logsBox.innerHTML = "";
        const sortedKeys = Object.keys(logs).sort((a,b)=>parseInt(a)-parseInt(b));
        sortedKeys.forEach(key => {
            addLog(logs[key]);
        });
    });
}


function calculateSize(obj) {
  let total = 0;
  function traverse(node) {
    if(typeof node === "string") {
      total += node.length;
    } else if(typeof node === "object" && node !== null) {
      for(let k in node) traverse(node[k]);
    }
  }
  traverse(obj);
  return total;
}

function updateBotSize() {
    const sizeRef = db.ref(`users/${currentUser}/bots/${currentBot}/files`);
    const maxRef = db.ref(`users/${currentUser}/bots/${currentBot}/maxLimit`);

    sizeRef.once("value").then(snap => {
        const files = snap.val() || {};
        const size = calculateSize(files);

        maxRef.once("value").then(maxSnap => {
            const max = maxSnap.val() || (50 * 1024 * 1024); // fallback 50MiB
            const sizeMiB = (size / (1024*1024)).toFixed(2);
            const maxMiB = (max / (1024*1024)).toFixed(2);

            document.getElementById("sizeText").innerText = sizeMiB;
            document.getElementById("maxText").innerText = maxMiB;

            let percent = Math.min(100, (size / max) * 100);
            const bar = document.getElementById("sizeBar");
            bar.style.width = percent + "%";

            if (percent >= 100) bar.style.background = "red";
            else if (max - size <= 10 * 1024 * 1024) bar.style.background = "orange";
            else bar.style.background = "green";
        });
    });
}


loadFiles();
</script>


</body>
</html>
