<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - H√©bergeur de Bots Python (Simulation)</title>
  <!-- Firebase compat (objet global `firebase`) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    :root{
      --bg:#13121a; --fg:#ffffff; --muted:#bfbfd6;
      --glass:rgba(255,255,255,0.06); --glass2:rgba(255,255,255,0.10);
      --accent1:#4facfe; --accent2:#00f2fe; --danger:#ff4d4d; --green:#17d96f; --red:#ff4d4d;
      --shadow:0 10px 40px rgba(0,0,0,.45); --radius:16px;
    }
    *{box-sizing:border-box} body{margin:0;height:100vh;display:flex;background:linear-gradient(135deg,#1f1c2c,#3b3753 50%, #5f5a7a);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    /* Sidebar */
    .sidebar{width:240px;background:var(--glass);backdrop-filter:blur(12px);display:flex;flex-direction:column;align-items:center;padding:24px 14px;box-shadow:2px 0 18px rgba(0,0,0,.35)}
    .logo{width:120px;height:auto;border-radius:14px;box-shadow:var(--shadow);object-fit:contain;background:rgba(255,255,255,.08)}
    .nav{margin-top:24px;width:100%;display:flex;flex-direction:column;gap:10px}
    .nav button{width:100%;padding:12px 14px;border:none;border-radius:12px;color:var(--fg);background:var(--glass2);text-align:left;cursor:pointer;transition:.2s transform,.2s background}
    .nav button:hover{background:rgba(255,255,255,.16);transform:translateY(-1px)}
    /* Main */
    .main{flex:1;padding:28px;overflow:auto}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .title{font-size:28px;font-weight:700;letter-spacing:.3px}
    .create{padding:12px 16px;border:none;border-radius:12px;font-weight:700;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 8px 24px rgba(0,242,254,.25);transition:.2s transform,.2s opacity}
    .create:hover{transform:translateY(-2px);opacity:.95}
    /* Cards */
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:var(--glass);backdrop-filter:blur(10px);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
    .name{font-weight:700;font-size:18px}
    .status{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:14px}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
    .on{background:var(--green);box-shadow:0 0 10px rgba(23,217,111,.6)}
    .off{background:var(--red);box-shadow:0 0 10px rgba(255,77,77,.6)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{flex:1;min-width:110px;padding:10px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700;color:#fff;transition:.2s opacity,.2s transform}
    .btn:hover{opacity:.92;transform:translateY(-1px)}
    .primary{background:linear-gradient(135deg,#6ea8fe,#4facfe)}
    .secondary{background:rgba(255,255,255,.18);color:#fff}
    .danger{background:linear-gradient(135deg,#ff7373,#ff4d4d)}
    .empty{margin-top:24px;padding:20px;text-align:center;color:var(--muted);background:var(--glass);border-radius:var(--radius)}
    @media (max-width:720px){.header{flex-direction:column;align-items:flex-start;gap:12px}.create{width:100%}}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <img src="logo.png" alt="Logo" class="logo" />
    <nav class="nav">
      <button onclick="goHome()">üè† Accueil</button>
      <button onclick="alert('Support non impl√©ment√© pour le moment.')">üõü Support</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="header">
      <div class="title">Bienvenue !</div>
      <button class="create" id="createBotBtn">+ Cr√©er un bot</button>
    </div>

    <section id="botsList" class="cards"></section>
    <div id="emptyState" class="empty" style="display:none;">
      Aucun bot pour le moment. Cr√©e ton premier bot avec ‚Äú+ Cr√©er un bot‚Äù.
    </div>
  </main>

  <script>
    // üî• Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
      authDomain: "kykychat-24c7f.firebaseapp.com",
      databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
      projectId: "kykychat-24c7f",
      storageBucket: "kykychat-24c7f.firebasestorage.app",
      messagingSenderId: "342562811927",
      appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
    };

    // Init Firebase (compat)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser = null;

    // Auth guard
    auth.onAuthStateChanged(user => {
      if (!user) { window.location.href = "index.html"; return; }
      currentUser = user;
      subscribeBots();
    });

    // Navigation
    function goHome(){ window.location.href = "dashboard.html"; }

    // Subscribe to bots list
    function subscribeBots(){
      const ref = db.ref("users/" + currentUser.uid + "/bots");
      ref.on("value", (snap) => renderBots(snap.val() || {}));
    }

    // Render
    function renderBots(bots){
      const container = document.getElementById("botsList");
      const empty = document.getElementById("emptyState");
      container.innerHTML = "";

      const ids = Object.keys(bots);
      empty.style.display = ids.length ? "none" : "block";

      ids.sort((a,b)=> (bots[a].createdAt||"").localeCompare(bots[b].createdAt||""));

      ids.forEach(botId => {
        const bot = bots[botId];
        const isOnline = !!bot.status;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="name">${escapeHtml(bot.name || botId)}</div>
          <div class="status">
            <span class="dot ${isOnline ? 'on':'off'}"></span>
            ${isOnline ? 'En ligne' : 'Hors ligne'}
          </div>
          <div class="row">
            ${isOnline
              ? `<button class="btn secondary" onclick="stopBot('${botId}')">Arr√™ter</button>`
              : `<button class="btn primary" onclick="startBot('${botId}')">D√©marrer</button>`
            }
            <button class="btn primary" onclick="editBot('${botId}')">√âditer</button>
          </div>
          <div class="row">
            <button class="btn secondary" onclick="viewBot('${botId}')">Voir</button>
            <button class="btn danger" onclick="deleteBot('${botId}')">Supprimer</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Create bot
    document.getElementById("createBotBtn").addEventListener("click", () => {
      const name = prompt("Nom du bot :");
      if (!name) return;

      // (Optionnel) token pour simulation ‚Äî n‚Äôutilise pas un vrai token ici
      const token = prompt("Token (optionnel - simulation) :") || "";

      const botId = "bot_" + Date.now();
      const defaultMainPy =
`# main.py ‚Äî Simulation h√©bergeur (frontend)
# ‚ö†Ô∏è Ex√©cution r√©elle √† faire c√¥t√© serveur (Node.js/Python), pas dans le navigateur.
print("Bot pr√™t (simulation).")
# Exemple discord.py (pour r√©f√©rence seulement) :
# import discord
# from discord.ext import commands
# bot = commands.Bot(command_prefix="!")
# @bot.event
# async def on_ready():
#     print("Connect√© en tant que", bot.user)
# bot.run("TON_TOKEN_ICI")`;

      const data = {
        name,
        status: false, // offline
        createdAt: new Date().toISOString(),
        token,         // ‚ö†Ô∏è simulation uniquement
        files: { "main_py": defaultMainPy }
      };

      db.ref(`users/${currentUser.uid}/bots/${botId}`).set(data);
    });

    // Start/Stop (simulation)
    function startBot(botId){
      db.ref(`users/${currentUser.uid}/bots/${botId}/status`).set(true);
    }
    function stopBot(botId){
      db.ref(`users/${currentUser.uid}/bots/${botId}/status`).set(false);
    }

    // Edit ‚Üí set noweditingBot + redirect
    function editBot(botId){
      db.ref(`users/${currentUser.uid}/noweditingBot`).set(botId).then(()=>{
        window.location.href = "bot-editing.html";
      });
    }

    // View (placeholder)
    function viewBot(botId){
      alert("Voir : non impl√©ment√© pour l‚Äôinstant (placeholder).");
    }

    // Delete
    function deleteBot(botId){
      if (!confirm("Supprimer ce bot ?")) return;
      db.ref(`users/${currentUser.uid}/bots/${botId}`).remove();
    }

    // Utils
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
    }
  </script>
</body>
</html>
